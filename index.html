<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Smart Travel Planner</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    
    <style>
        :root { --primary: #2c3e50; --food: #e67e22; --fuel: #3498db; }
        body { margin: 0; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; }
        header { background: var(--primary); color: white; padding: 12px; text-align: center; font-weight: bold; }
        
        #main { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        #map { height: 45vh; width: 100%; }
        #list { flex: 1; overflow-y: auto; padding: 15px; background: white; }

        /* Filter Buttons Styling */
        .filter-bar { display: flex; gap: 10px; margin-bottom: 15px; }
        .filter-btn { 
            flex: 1; padding: 8px; border: none; border-radius: 20px; 
            cursor: pointer; font-weight: bold; font-size: 12px; background: #eee; 
        }
        .filter-btn.active[data-cat="all"] { background: var(--primary); color: white; }
        .filter-btn.active[data-cat="food"] { background: var(--food); color: white; }
        .filter-btn.active[data-cat="fuel"] { background: var(--fuel); color: white; }

        .card { border: 1px solid #eee; padding: 12px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card.food { border-left: 5px solid var(--food); }
        .card.fuel { border-left: 5px solid var(--fuel); }
        .nav-btn { display: block; background: #333; color: white; text-align: center; padding: 8px; border-radius: 5px; text-decoration: none; margin-top: 8px; }

        @media (min-width: 768px) { #main { flex-direction: row; } #map { flex: 2; height: auto; } #list { flex: 1; max-width: 350px; } 
    </style>
</head>
<body>

<header>Smart Travel Planner</header>

<div id="main">
    <div id="map"></div>
    <div id="list">
        <div class="filter-bar">
            <button class="filter-btn active" data-cat="all">ALL</button>
            <button class="filter-btn" data-cat="food">üç¥ FOOD</button>
            <button class="filter-btn" data-cat="fuel">‚õΩ PETROL</button>
        </div>

        <div id="places-container"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
// 1. Initialize Map
    var map = L.map('map').setView([3.3, 101.9], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // 2. Setup the Routing Control
    var control = L.Routing.control({
        // Start with NO fixed waypoints so the user can type their own
        waypoints: [
            null, // Start point (waiting for input)
            null  // End point (waiting for input)
        ],
        routeWhileDragging: true,
        // This line is key: it tells the boxes to use the "Nominatim" search engine
        geocoder: L.Control.Geocoder.nominatim(),
        router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1'
        })
    }).addTo(map);

    // 3. Add Locate Me
    L.control.locate({ position: 'topleft', flyTo: true }).addTo(map);

    // 4. Handle "Route Found" to update your stopover list
    control.on('routesfound', function(e) {
        var route = e.routes[0];
        console.log("New route found! Distance: " + route.summary.totalDistance);
        
        // This function (from our previous code) filters your stops
        filterAndDisplay(route.coordinates); 
    });

    // Helper to filter stops (same logic as before)
    function filterAndDisplay(routeCoords) {
        const container = document.getElementById('places-container');
        container.innerHTML = ""; 

        const filtered = allStops.filter(stop => {
            const matchesCat = (currentCategory === "all" || stop.cat === currentCategory);
            const matchesRoute = routeCoords.some(coord => {
                let dist = Math.sqrt(Math.pow(coord.lat - stop.lat, 2) + Math.pow(coord.lng - stop.lng, 2));
                return dist < 0.05; 
            });
            return matchesCat && matchesRoute;
        });

        // ... code to draw cards ...
    }
</script>
    <style>
    /* Styling for the Swap Button */
    .swap-container {
        position: absolute;
        top: 80px; /* Position it near the routing box */
        right: 10px;
        z-index: 1000;
    }
    .swap-btn {
        background: white;
        border: 2px solid rgba(0,0,0,0.2);
        border-radius: 4px;
        padding: 5px 10px;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    }
    .swap-btn:hover { background: #f4f4f4; }
</style>

<div class="swap-container">
    <button class="swap-btn" onclick="swapWaypoints()">‚áÖ Swap</button>
</div>

<script>
    function swapWaypoints() {
        // Get the current waypoints from the routing control
        var currentWaypoints = control.getWaypoints();
        
        // Swap the coordinates
        var newWaypoints = [
            currentWaypoints[1].latLng, // Old destination becomes new start
            currentWaypoints[0].latLng  // Old start becomes new destination
        ];

        // Set the new waypoints back to the control
        control.setWaypoints(newWaypoints);
    }
</script>
</body>
</html>
